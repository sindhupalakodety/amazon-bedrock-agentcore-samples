AWSTemplateFormatVersion: "2010-09-09"
Description: "EC2 instance with Docker, Bedrock access, and automated deployment for ICARUS web app"

Parameters:
  InstanceType:
    Type: String
    Default: t3.medium
    Description: EC2 instance type
    AllowedValues:
      - t3.small
      - t3.medium
      - t3.large
      - t3.xlarge

  KeyName:
    Type: String
    Default: ""
    Description: (Optional) EC2 Key Pair for SSH access. Leave empty to use SSM Session Manager only

  CodeS3Bucket:
    Type: String
    Description: S3 bucket containing your application code (zip file)

  CodeS3Key:
    Type: String
    Description: S3 key for your application code zip file
    Default: app-code.zip

  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64

Conditions:
  HasKeyName: !Not [!Equals [!Ref KeyName, ""]]

Resources:
  # VPC
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-VPC"

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-IGW"

  # Attach Internet Gateway to VPC
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # Public Subnet (for NAT Gateway only)
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: false
      AvailabilityZone: !Select [0, !GetAZs ""]
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-PublicSubnet"

  # Private Subnet (for EC2 instance)
  PrivateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      MapPublicIpOnLaunch: false
      AvailabilityZone: !Select [0, !GetAZs ""]
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-PrivateSubnet"

  # Elastic IP for NAT Gateway
  NatGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-NatGateway-EIP"

  # NAT Gateway
  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-NatGateway"

  # Public Route Table
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-PublicRouteTable"

  # Route to Internet Gateway (for public subnet)
  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  # Associate Public Subnet with Public Route Table
  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  # Private Route Table
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-PrivateRouteTable"

  # Route to NAT Gateway (for private subnet)
  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  # Associate Private Subnet with Private Route Table
  PrivateSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet
      RouteTableId: !Ref PrivateRouteTable

  # KMS Key for CloudWatch Logs Encryption
  LogGroupKMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: KMS key for encrypting CloudWatch Log Group
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action: "kms:*"
            Resource: "*"
          - Sid: Allow CloudWatch Logs
            Effect: Allow
            Principal:
              Service: !Sub "logs.${AWS::Region}.amazonaws.com"
            Action:
              - "kms:Encrypt"
              - "kms:Decrypt"
              - "kms:ReEncrypt*"
              - "kms:GenerateDataKey*"
              - "kms:CreateGrant"
              - "kms:DescribeKey"
            Resource: "*"
            Condition:
              ArnLike:
                "kms:EncryptionContext:aws:logs:arn": !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/ec2/${AWS::StackName}"

  # KMS Key Alias
  LogGroupKMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-logs-key"
      TargetKeyId: !Ref LogGroupKMSKey

  # CloudWatch Log Group with KMS Encryption
  LogGroup:
    Type: AWS::Logs::LogGroup
    DependsOn: LogGroupKMSKey
    Properties:
      LogGroupName: !Sub "/aws/ec2/${AWS::StackName}"
      RetentionInDays: 7
      KmsKeyId: !GetAtt LogGroupKMSKey.Arn

  # Managed Policy for Bedrock Access
  BedrockAccessManagedPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Managed policy for Bedrock access
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - bedrock:InvokeModel
              - bedrock:InvokeModelWithResponseStream
            Resource:
              - !Sub "arn:aws:bedrock:*::foundation-model/*"
              - !Sub "arn:aws:bedrock:*:${AWS::AccountId}:inference-profile/*"
          - Effect: Allow
            Action:
              - bedrock:ListFoundationModels
              - bedrock:GetFoundationModel
            Resource: !Sub "arn:aws:bedrock:*::foundation-model/*"

  # Managed Policy for S3 Code Access
  S3CodeAccessManagedPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Managed policy for S3 code access
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:ListBucket
            Resource:
              - !Sub "arn:aws:s3:::${CodeS3Bucket}"
              - !Sub "arn:aws:s3:::${CodeS3Bucket}/*"

  # Managed Policy for CloudWatch Logs
  CloudWatchLogsManagedPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Managed policy for CloudWatch Logs access
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
              - logs:DescribeLogStreams
            Resource:
              - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/ec2/${AWS::StackName}"
              - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/ec2/${AWS::StackName}:*"

  # IAM Role for EC2 Instance
  IAMRoleForEC2Instance:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - !Ref BedrockAccessManagedPolicy
        - !Ref S3CodeAccessManagedPolicy
        - !Ref CloudWatchLogsManagedPolicy

  # Instance Profile
  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub "${AWS::StackName}-InstanceProfile"
      Roles:
        - !Ref IAMRoleForEC2Instance

  # Security Group
  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for EC2 instance (no inbound ports exposed)
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - Description: Allow HTTPS outbound to AWS services and internet
          IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - Description: Allow HTTP outbound for package downloads
          IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - Description: Allow DNS queries
          IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-SecurityGroup"

  # EC2 Instance
  EC2Instance:
    Type: AWS::EC2::Instance
    DependsOn: NatGateway
    Properties:
      InstanceType: !Ref InstanceType
      ImageId: !Ref LatestAmiId
      SubnetId: !Ref PrivateSubnet
      KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
      IamInstanceProfile: !Ref EC2InstanceProfile
      SecurityGroupIds:
        - !Ref EC2SecurityGroup
      EbsOptimized: true
      Monitoring: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-Instance"
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e

          # Log everything to a file
          exec > >(tee /var/log/user-data.log)
          exec 2>&1

          # Install CloudWatch agent
          echo "Installing CloudWatch agent..."
          yum install -y amazon-cloudwatch-agent

          # Configure CloudWatch agent
          cat > /opt/aws/amazon-cloudwatch-agent/etc/config.json <<'CWCONFIG'
          {
            "logs": {
              "logs_collected": {
                "files": {
                  "collect_list": [
                    {
                      "file_path": "/var/log/user-data.log",
                      "log_group_name": "/aws/ec2/${AWS::StackName}",
                      "log_stream_name": "user-data"
                    },
                    {
                      "file_path": "/var/log/setup.log",
                      "log_group_name": "/aws/ec2/${AWS::StackName}",
                      "log_stream_name": "setup"
                    },
                    {
                      "file_path": "/var/log/app.log",
                      "log_group_name": "/aws/ec2/${AWS::StackName}",
                      "log_stream_name": "app"
                    }
                  ]
                }
              }
            }
          }
          CWCONFIG

          # Start CloudWatch agent
          echo "Starting CloudWatch agent..."
          /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
            -a fetch-config \
            -m ec2 \
            -s \
            -c file:/opt/aws/amazon-cloudwatch-agent/etc/config.json

          echo "=== Starting UserData script ==="

          # Update system
          echo "Updating system packages..."
          yum update -y

          # Install Docker
          echo "Installing Docker..."
          yum install -y docker
          systemctl start docker
          systemctl enable docker
          usermod -a -G docker ec2-user

          # Install Docker Compose
          echo "Installing Docker Compose..."
          curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          chmod +x /usr/local/bin/docker-compose

          # Install AWS CLI v2 (if not already present)
          echo "Installing AWS CLI v2..."
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          yum install -y unzip
          unzip -q awscliv2.zip
          ./aws/install
          rm -rf aws awscliv2.zip

          # Configure AWS CLI for the region
          echo "Configuring AWS CLI..."
          mkdir -p /home/ec2-user/.aws
          cat > /home/ec2-user/.aws/config <<EOF
          [default]
          region = ${AWS::Region}
          output = json
          EOF

          # Set credentials to use instance profile
          cat > /home/ec2-user/.aws/credentials <<EOF
          # Using IAM Instance Profile - no credentials needed
          EOF

          chown -R ec2-user:ec2-user /home/ec2-user/.aws
          chmod 700 /home/ec2-user/.aws
          chmod 600 /home/ec2-user/.aws/config
          chmod 600 /home/ec2-user/.aws/credentials

          # Create application directory
          echo "Creating application directory..."
          mkdir -p /home/ec2-user/app
          cd /home/ec2-user/app

          # Download application code from S3
          echo "Downloading application code from S3..."
          aws s3 cp s3://${CodeS3Bucket}/${CodeS3Key} /home/ec2-user/app/app-code.zip

          # Extract the code
          echo "Extracting application code..."
          unzip -q app-code.zip
          rm app-code.zip

          # Set ownership
          chown -R ec2-user:ec2-user /home/ec2-user/app

          # Make scripts executable
          echo "Making scripts executable..."
          chmod +x /home/ec2-user/app/setup.sh
          chmod +x /home/ec2-user/app/run_app.sh

          # Run setup script
          echo "Running setup.sh..."
          cd /home/ec2-user/app
          if ! sudo -u ec2-user bash -c 'cd /home/ec2-user/app && ./setup.sh' 2>&1 | tee /var/log/setup.log; then
            echo "ERROR: setup.sh failed"
            /opt/aws/bin/cfn-signal -e 1 --stack ${AWS::StackName} --resource EC2Instance --region ${AWS::Region}
            exit 1
          fi

          # Wait for Docker daemon to be fully ready
          echo "Waiting for Docker daemon to be ready..."
          sleep 10

          # Create log file with proper permissions
          touch /var/log/app.log
          chown ec2-user:ec2-user /var/log/app.log

          # Run the application
          echo "Starting application with run_app.sh..."
          if ! sudo -u ec2-user bash -c 'cd /home/ec2-user/app && ./run_app.sh > /var/log/app.log 2>&1 &'; then
            echo "ERROR: run_app.sh failed"
            /opt/aws/bin/cfn-signal -e 1 --stack ${AWS::StackName} --resource EC2Instance --region ${AWS::Region}
            exit 1
          fi

          # Create a systemd service for the app (optional, for auto-restart)
          cat > /etc/systemd/system/webapp.service <<EOF
          [Unit]
          Description=Web Application
          After=docker.service
          Requires=docker.service

          [Service]
          Type=forking
          User=ec2-user
          WorkingDirectory=/home/ec2-user/app
          ExecStart=/home/ec2-user/app/run_app.sh
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
          EOF

          # Enable the service (commented out - uncomment if you want auto-restart on boot)
          # systemctl daemon-reload
          # systemctl enable webapp.service

          echo "=== UserData script completed successfully ==="

          # Signal CloudFormation that the instance is ready
          yum install -y aws-cfn-bootstrap
          /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource EC2Instance --region ${AWS::Region}
    CreationPolicy:
      ResourceSignal:
        Count: 1
        Timeout: PT15M

Outputs:
  InstanceId:
    Description: EC2 Instance ID
    Value: !Ref EC2Instance
    Export:
      Name: !Sub "${AWS::StackName}-InstanceId"

  SSMCommand:
    Description: Command to connect via AWS Systems Manager Session Manager (only access method)
    Value: !Sub "aws ssm start-session --target ${EC2Instance} --region ${AWS::Region}"

  CloudWatchLogGroup:
    Description: CloudWatch Log Group for instance logs
    Value: !Ref LogGroup
    Export:
      Name: !Sub "${AWS::StackName}-LogGroup"

  CodeS3Bucket:
    Description: S3 bucket containing application code
    Value: !Ref CodeS3Bucket
    Export:
      Name: !Sub "${AWS::StackName}-CodeS3Bucket"
